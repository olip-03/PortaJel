@using PortaJel_Blazor.Data;
@using PortaJel_Blazor;
@using Microsoft.Maui.Controls;
@using PortaJel_Blazor.Pages;
@using PortaJel_Blazor.Classes;
@inject NavigationManager NavigationManager
@namespace PortaJel_Blazor.Shared

<div class="containerImg">
    <div class="imageHolder">
        <img src="data:image/png;base64, @placeholderBase64" class="albumImage lowRes" />
        <img src="@albumImg" class="albumImage album-cover-img opacityTransition" loading="lazy" @onclick="NavigateToAlbum" @oncontextmenu="OpenContextMenu" onerror="this.src='/images/emptyAlbum.png'" />
    </div>

    @if(musicObject != null)
    {
        <p class="albumText" @onclick="NavigateToAlbum">
            @if (musicObject is Song)
            { // Show the little song icon
                <img src="/images/song.svg" style="height: 1rem; width: 1rem;"/>
            }
            else
            {
                <img src="/images/album.svg" style="height: 1rem; width: 1rem;"/>
            }
            @musicObject.name • @artistName
        </p>
    }
</div>

<style>
    .containerImg {
        display: flex;
        flex-direction: column;
        height: auto; /* Change height to 'auto' */
        inline-size: 160px;
        margin-right: 10px;
    }
</style>

@code {
    [Parameter] public BaseMusicItem musicObject { get; set; } = new Album();
    [Parameter] public string placeholderBase64 { get; set; } = String.Empty;
    [Parameter] public int? albumResolutionpx { get; set; } = 160;
    string? albumText = null;
    string? artistName = null;

    private int resolution = 250;

    private string albumImg { get; set; } = String.Empty;
    private string backImg { get; set; } = String.Empty;

    protected override void OnInitialized()
    {
        if(musicObject != null)
        {
            albumImg = musicObject.image.SourceAtResolution(resolution);
            backImg = musicObject.image.SourceAtResolution(25);

            if (musicObject is Album)
            {
                Album album = (Album)musicObject;
                artistName = album.artistCongregate;
            }
            if (musicObject is Song)
            {
                Song song = (Song)musicObject;
                artistName = song.artistCongregate;
            }
            StateHasChanged();
        }
    }

    private void NavigateToAlbum()
    {
        if (musicObject != null)
        {
            if (musicObject is Album)
            {
                Album album = (Album)musicObject;
                MauiProgram.mainPage.ShowLoadingScreen(true);
                MauiProgram.webView.NavigateAlbum(album.id);
            }
            if (musicObject is Song)
            {
                Song song = (Song)musicObject;
                Album? album = song.album;
                if(album != null)
                {
                    MauiProgram.mainPage.ShowLoadingScreen(true);
                    MauiProgram.webView.NavigateAlbum(album.id);
                }
            }
        }
    }

    private async void OpenContextMenu()
    {
        await MauiProgram.mainPage.OpenContextMenu(musicObject, 250);
        await Task.Run(() =>
        {
            // Literally just waiting for the fucking thing to close before we refresh
            while (MauiProgram.ContextMenuIsOpen == true)
            {

            }
        });
        StateHasChanged();
    }

}