<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:PortaJel_Blazor"
             xmlns:pages="clr-namespace:PortaJel_Blazor.Pages"
             x:Class="PortaJel_Blazor.MainPage"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             Shell.NavBarIsVisible="False"
             Shell.TabBarIsVisible="False">
    <Grid VerticalOptions="Fill" HorizontalOptions="Fill" x:Name="AllContent">
        <!-- Webview -->
        <BlazorWebView x:Name="blazorWebView" HostPage="wwwroot/index.html" BlazorWebViewInitialized="Bwv_BlazorWebViewInitialized">
            <BlazorWebView.RootComponents>
                <RootComponent Selector="#app" ComponentType="{x:Type local:Main}" />
            </BlazorWebView.RootComponents>
        </BlazorWebView>
        
        <!-- Loading blockout -->
        <Grid x:Name="LoadingBlockout" BackgroundColor="White" VerticalOptions="FillAndExpand" HorizontalOptions="FillAndExpand" InputTransparent="False" IsVisible="true">
            <ActivityIndicator x:Name="save_activityIndicator" IsRunning="True" IsVisible="True" HeightRequest="80" WidthRequest="80" VerticalOptions="Center" HorizontalOptions="Center"/>

            <Grid.GestureRecognizers>
                <TapGestureRecognizer>
                    <!--Do NOTHING! I just don't want fucking tapps passing this grid RRAHHH-->
                </TapGestureRecognizer>
            </Grid.GestureRecognizers>
        </Grid>


        <!-- Navigation Bar -->
        <StackLayout Orientation="Vertical" x:Name="Navbar" HeightRequest="120" VerticalOptions="End" HorizontalOptions="Fill" AnchorY="0" InputTransparent="False" IsVisible="false">
            <!-- MiniPlayer -->
            <Border x:Name="Player"
                    Stroke="LightGray"
                    StrokeThickness="0"
                    StrokeShape="RoundRectangle 5,5,5,5"
                    Margin="10, 0, 10, 0"
                    ZIndex="5">
                <Border.Shadow>
                    <Shadow Brush="Black"
                            Offset="5,5"
                            Radius="15"
                            Opacity="0.7" />
                </Border.Shadow>
                <Grid>
                    <FlexLayout HorizontalOptions="FillAndExpand" VerticalOptions="FillAndExpand" BackgroundColor="White" HeightRequest="60" AlignItems="Center">
                        <!-- Image -->
                        <Border FlexLayout.Shrink="0" WidthRequest="50" HeightRequest="50" Margin="2.5, 0, 2.5, 0" StrokeShape="RoundRectangle 5,5,5,5">
                            <Image Source="emptyAlbum.png" WidthRequest="50" HeightRequest="50"></Image>
                        </Border>
                        <!-- Song and Artist Text-->
                        <Grid FlexLayout.Basis="50%" FlexLayout.Grow="1">
                            <Label x:Name="Player_Txt_Title" Grid.Row="0" Text="Current Playing Song Title" MaxLines="1" FontSize="18" TextColor="Black"/>
                            <Label x:Name="Player_Txt_Artist" Grid.Row="1" Text="Current Playing Artist" MaxLines="1" FontSize="12" TextColor="Gray"/>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                        </Grid>
                        <!-- Playback Controls -->
                        <StackLayout Orientation="Horizontal" FlexLayout.Grow="0" HeightRequest="50" Margin="2.5, 0, 2.5, 0">
                            <ImageButton x:Name="Player_Btn_FavToggle" Clicked="Player_Btn_FavToggle_Clicked" WidthRequest="40" HeightRequest="40" Source="heart.png"/>
                            <ImageButton x:Name="Player_Btn_PlayToggle" Clicked="Player_Btn_PlayToggle_Clicked" WidthRequest="40" HeightRequest="40" Source="play.png"/>
                        </StackLayout>
                    </FlexLayout>
                    <Border StrokeThickness="0"
                            StrokeShape="RoundRectangle 2,2,2,2"
                            Margin="20, 0, 20, 0"
                            BackgroundColor="Transparent"
                            VerticalOptions="End">
                        <ProgressBar Progress="0.7" HeightRequest="4" BackgroundColor="Transparent"/>
                    </Border>

                    <Grid.GestureRecognizers>
                        <PanGestureRecognizer PanUpdated="Navbar_PinchUpdated"/>
                        <TapGestureRecognizer Tapped="MiniPlayer_Clicked"/>
                        <SwipeGestureRecognizer Direction="Up" Swiped="MiniPlayer_Clicked"></SwipeGestureRecognizer>
                    </Grid.GestureRecognizers>
                </Grid>
            </Border>
            <!-- Navigation Buttons -->
            <FlexLayout HeightRequest="60" HorizontalOptions="Fill" VerticalOptions="Fill" JustifyContent="SpaceEvenly" AlignItems="Center">
                <ImageButton x:Name="btn_navnar_home" Source="home.png"  WidthRequest="40" HeightRequest="40" Clicked="btn_navnar_home_click"/>
                <ImageButton x:Name="btn_navnar_search" Source="search.png"  WidthRequest="40" HeightRequest="40" Clicked="btn_navnar_search_click"/>
                <ImageButton x:Name="btn_navnar_library" Source="library.png"  WidthRequest="40" HeightRequest="40" Clicked="btn_navnar_library_click"/>
                <ImageButton x:Name="btn_navnar_favourites" Source="favourite.png"  WidthRequest="40" HeightRequest="40" Clicked="btn_navnar_favourite_click"/>
            </FlexLayout>

            <!-- LAYOUT -->
            <!-- Background -->
            <StackLayout.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                    <GradientStop Color="Transparent" Offset="0.0" />
                    <GradientStop Color="White" Offset="1.0" />
                </LinearGradientBrush>
            </StackLayout.Background>
        </StackLayout>

        <!-- Media Player Controls -->
        <Grid x:Name="MediaController" BackgroundColor="White" VerticalOptions="FillAndExpand" HorizontalOptions="FillAndExpand" InputTransparent="False" IsVisible="false">
            <!-- Controller -->
            <Grid x:Name="MediaController_Player" VerticalOptions="FillAndExpand" HorizontalOptions="FillAndExpand">
                <!-- Header -->
                <Grid Grid.Row="0">
                    <ImageButton Clicked="Button_Clicked" WidthRequest="40" HeightRequest="40" Source="down.png" Grid.Column="0">
                        <ImageButton.GestureRecognizers>
                            <TapGestureRecognizer Tapped="Button_Clicked"></TapGestureRecognizer>
                        </ImageButton.GestureRecognizers>
                    </ImageButton>
                    <StackLayout Grid.Column="1" VerticalOptions="Center">
                        <Label Text="Playing from Album" TextColor="Black" FontSize="16" HorizontalOptions="Center"></Label>
                        <Label Text="Album Name" TextColor="Black" FontSize="14" HorizontalOptions="Center"></Label>
                    </StackLayout>
                    <ImageButton Clicked="MediaController_Btn_ContextMenu" WidthRequest="40" HeightRequest="40" Source="more_horiz.png" Grid.Column="2">
                        <ImageButton.GestureRecognizers>
                            <TapGestureRecognizer Tapped="MediaController_Btn_ContextMenu"></TapGestureRecognizer>
                        </ImageButton.GestureRecognizers>
                    </ImageButton>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="70"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="70"/>
                    </Grid.ColumnDefinitions>
                </Grid>
                <!-- Image and item text -->
                <Grid Grid.Row="1">
                    <StackLayout Margin="50, 0, 50, 0" VerticalOptions="Center">
                        <Image Source="emptyAlbum.png" MaximumHeightRequest="350"></Image>
                        <Label TextColor="Black" Text="Song Title" FontSize="28" HorizontalOptions="Center"></Label>
                        <Label TextColor="Black" Text="Artist Name" FontSize="20" HorizontalOptions="Center"></Label>
                    </StackLayout>
                </Grid>
                <!-- Playback controls -->
                <Grid Grid.Row="2">
                    <StackLayout Margin="10, 0, 10, 0" VerticalOptions="Start">
                        <Slider Maximum="100" Value="100" Margin="0" MaximumTrackColor="Gray" BackgroundColor="Transparent" HorizontalOptions="FillAndExpand"/>
                        <FlexLayout  Margin="20, 0, 20, 0" JustifyContent="SpaceBetween" >
                            <Label TextColor="Black" Text="0:00"></Label>
                            <Label TextColor="Black" Text="0:00"></Label>
                        </FlexLayout>
                    </StackLayout>

                    <StackLayout VerticalOptions="Center">
                        <FlexLayout JustifyContent="SpaceBetween" AlignItems="Center" Margin="20">
                            <ImageButton HeightRequest="40" WidthRequest="40" BackgroundColor="Transparent" Source="repeat_off.png"></ImageButton>
                            <ImageButton HeightRequest="40" WidthRequest="40" BackgroundColor="Transparent" Source="skip_previous.png"></ImageButton>
                            <Frame CornerRadius="40" Padding="0" Margin="0" HeightRequest="80" WidthRequest="80" BackgroundColor="LightGray">
                                <ImageButton Aspect="AspectFit" 
                                             VerticalOptions="Center"
                                             HorizontalOptions="Center" 
                                             BackgroundColor="Transparent" 
                                             HeightRequest="50" 
                                             WidthRequest="50" 
                                             Source="play.png"/>
                            </Frame>
                            <ImageButton HeightRequest="40" WidthRequest="40" BackgroundColor="Transparent" Source="skip_next.png"></ImageButton>
                            <ImageButton HeightRequest="40" WidthRequest="40" BackgroundColor="Transparent" Source="shuffle.png"></ImageButton>
                        </FlexLayout>
                        <FlexLayout JustifyContent="SpaceBetween" AlignItems="Center" Margin="20">
                            <ImageButton HeightRequest="40" WidthRequest="40" BackgroundColor="Transparent" Source="heart.png"></ImageButton>
                            <ImageButton HeightRequest="40" WidthRequest="40" BackgroundColor="Transparent" Source="queue.png" Clicked="MediaController_Queue_Show"></ImageButton>
                        </FlexLayout>
                    </StackLayout>
                </Grid>

                <Grid.RowDefinitions>
                    <RowDefinition Height="70"/>
                    <RowDefinition Height="2*"/>
                    <RowDefinition Height="1.2*"/>
                </Grid.RowDefinitions>
            </Grid>
            <!-- Queue -->
            <Grid x:Name="MediaController_Queue" VerticalOptions="FillAndExpand" HorizontalOptions="FillAndExpand" IsVisible="false" BackgroundColor="White">
                <!-- Header -->
                <Grid Grid.Row="0">
                    <ImageButton Clicked="MediaController_Queue_Hide" WidthRequest="40" HeightRequest="40" Source="down.png" Grid.Column="0">
                        <ImageButton.GestureRecognizers>
                            <TapGestureRecognizer Tapped="MediaController_Queue_Hide"></TapGestureRecognizer>
                        </ImageButton.GestureRecognizers>
                    </ImageButton>
                    <StackLayout Grid.Column="1" VerticalOptions="Center">
                        <Label Text="Playing from Album" TextColor="Black" FontSize="16" HorizontalOptions="Center"></Label>
                        <Label Text="Album Name" TextColor="Black" FontSize="14" HorizontalOptions="Center"></Label>
                    </StackLayout>
                    <ImageButton Clicked="MediaController_Btn_ContextMenu" WidthRequest="40" HeightRequest="40" Source="more_horiz.png" Grid.Column="2">
                        <ImageButton.GestureRecognizers>
                            <TapGestureRecognizer Tapped="MediaController_Btn_ContextMenu"></TapGestureRecognizer>
                        </ImageButton.GestureRecognizers>
                    </ImageButton>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="70"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="70"/>
                    </Grid.ColumnDefinitions>
                </Grid>

                <Grid InputTransparent="False" Grid.Row="1">
                    <CollectionView CanReorderItems="True" x:Name="MediaController_Queue_List" InputTransparent="False" >
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="20, 0, 0, 10">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <Image Grid.RowSpan="2"
                                           Source="{Binding imageSrc}"
                                           Aspect="AspectFill"
                                           HeightRequest="60"
                                           WidthRequest="60" Margin="0, 0, 10, 0"/>
                                    <Label Grid.Column="1"
                                           Text="{Binding name}"
                                           FontAttributes="Bold" 
                                           TextColor="Black"/>
                                    <Label Grid.Row="1"
                                           Grid.Column="1"
                                           Text="{Binding artist}"
                                           FontAttributes="Italic"
                                           VerticalOptions="End"
                                           TextColor="Black"/>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </Grid>


                <Grid Grid.Row="2">
                    <Border StrokeThickness="0"
                            StrokeShape="RoundRectangle 2,2,2,2"
                            Margin="10, 0, 10, 0"
                            BackgroundColor="Transparent"
                            VerticalOptions="Start">
                        <ProgressBar Progress="0.7" HeightRequest="4" BackgroundColor="Transparent"/>
                    </Border>

                    <FlexLayout JustifyContent="SpaceBetween" AlignItems="Center" Margin="20">
                        <ImageButton HeightRequest="40" WidthRequest="40" BackgroundColor="Transparent" Source="repeat_off.png"></ImageButton>
                        <ImageButton HeightRequest="40" WidthRequest="40" BackgroundColor="Transparent" Source="skip_previous.png"></ImageButton>
                        <Frame CornerRadius="40" Padding="0" Margin="0" HeightRequest="80" WidthRequest="80" BackgroundColor="LightGray">
                            <ImageButton Aspect="AspectFit" 
                             VerticalOptions="Center"
                             HorizontalOptions="Center" 
                             BackgroundColor="Transparent" 
                             HeightRequest="50" 
                             WidthRequest="50" 
                             Source="play.png"/>
                        </Frame>
                        <ImageButton HeightRequest="40" WidthRequest="40" BackgroundColor="Transparent" Source="skip_next.png"></ImageButton>
                        <ImageButton HeightRequest="40" WidthRequest="40" BackgroundColor="Transparent" Source="shuffle.png"></ImageButton>
                    </FlexLayout>
                </Grid>

                <Grid.RowDefinitions>
                    <RowDefinition Height="70"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="120"/>
                </Grid.RowDefinitions>
            </Grid>
            <Grid.GestureRecognizers>
                <TapGestureRecognizer>
                    <!--Do NOTHING! I just don't want fucking tapps passing this grid RRAHHH-->
                </TapGestureRecognizer>
            </Grid.GestureRecognizers>
        </Grid>

        <!-- Context Menus -->
        <!-- TODO: Add 'Swipe down to close' function to contextmenu -->
        <Grid x:Name="ContextMenu" VerticalOptions="FillAndExpand" HorizontalOptions="FillAndExpand" IsVisible="false">
            <!--Image Container -->
            <Grid x:Name="ContextMenu_imagecontainer">
                <Border Grid.Row="1" HorizontalOptions="Center" StrokeShape="RoundRectangle 5,5,5,5"  WidthRequest="250">
                    <Image x:Name="ContextMenu_image" Source="{Binding ContextMenuImage}" WidthRequest="250" Aspect="AspectFit"></Image>
                </Border>
                <StackLayout  VerticalOptions="Start" Grid.Row="2">
                    <Label x:Name="ContextMenu_MainText" Text="{Binding ContextMenuMainText}" FontSize="25" HorizontalTextAlignment="Center" Margin="30,0,30,0"></Label>
                    <Label x:Name="ContextMenu_SubText" Text="{Binding ContextMenuSubText}" FontSize="18" HorizontalTextAlignment="Center" Margin="30,0,30,0" ></Label>
                </StackLayout>

                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="2.5*"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
            </Grid>

            <!--Item List-->
            <ListView Grid.Row="1" x:Name="ContextMenu_List" Margin="20" ItemSelected="ContextMenu_SelectedItemChanged" SelectionMode="Single" IsVisible="True">
                <ListView.ItemTemplate>
                    <DataTemplate>
                        <ViewCell>
                            <FlexLayout AlignItems="Center" HeightRequest="50">
                                <Image HeightRequest="35" WidthRequest="35" Source="{Binding itemIcon}" VerticalOptions="Center"></Image>
                                <Label Text="{Binding itemName}" VerticalOptions="Center" Margin="5" FontSize="18"></Label>
                            </FlexLayout>
                        </ViewCell>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>

            <!--LAYOUT-->
            <!--Row Definitions-->
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            <!--Background-->
            <Grid.Background>
                <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                    <GradientStop Color="Transparent" Offset="0.0" />
                    <GradientStop Color="Black" Offset="0.6" />
                    <GradientStop Color="Black" Offset="1.0" />
                </LinearGradientBrush>
            </Grid.Background>
        </Grid>
    </Grid>
</ContentPage>